"""
Odoo API-Based Complete Automation Agent
Uses Odoo XML-RPC API for reliable, complete automation

This agent:
1. Configures everything via API (warehouses, products, routes, pricelists)
2. Uses browser automation only for complex UI interactions
3. Provides 95%+ automation with minimal manual intervention

Requirements:
pip install odoorpc selenium webdriver-manager
"""

import odoorpc
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.chrome.service import Service
import time
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


class OdooAPIAgent:
    def __init__(self, url, db, username, api_key):
        """Initialize with API credentials"""
        self.url = url
        self.db = db
        self.username = username
        self.api_key = api_key
        self.odoo = None
        self.uid = None
        self.driver = None
        self.wait = None
        
        # Business data
        self.customer_email = "maciej.narojczyk1@pjwstk.edu.pl"
        self.customer_name = "Maciej Narojczyk"
        self.warehouses = {}
        self.products = {}
        
    def connect_api(self):
        """Connect to Odoo API"""
        logger.info(f"Connecting to Odoo API at {self.url}...")
        
        try:
            # Fix SSL certificate issue on Mac
            import ssl
            ssl._create_default_https_context = ssl._create_unverified_context
            
            # Remove https://, http://, and /odoo path
            clean_url = self.url.replace('https://', '').replace('http://', '')
            clean_url = clean_url.replace('/odoo', '').replace('/web', '')
            clean_url = clean_url.rstrip('/')
            
            logger.info(f"Connecting to: {clean_url}")
            
            # Connect
            self.odoo = odoorpc.ODOO(clean_url, protocol='jsonrpc+ssl', port=443)
            
            # Login
            self.odoo.login(self.db, self.username, self.api_key)
            self.uid = self.odoo.env.uid
            
            logger.info(f"âœ… Connected! User ID: {self.uid}")
            return True
            
        except Exception as e:
            logger.error(f"âŒ API Connection failed: {e}")
            logger.info("\nTroubleshooting:")
            logger.info("1. Check your API key is correct")
            logger.info("2. Verify database name matches your URL")
            logger.info("3. Ensure External API access is enabled for your user")
            logger.info("4. Try just the domain: edu-loopingcomp.odoo.com")
            return False
    
    def setup_browser(self):
        """Setup browser for UI-only tasks"""
        logger.info("Setting up browser for UI tasks...")
        options = webdriver.ChromeOptions()
        options.add_argument('--start-maximized')
        
        service = Service(ChromeDriverManager().install())
        self.driver = webdriver.Chrome(service=service, options=options)
        self.wait = WebDriverWait(self.driver, 20)
        logger.info("Browser ready")

    # ============ CONFIGURATION VIA API ============
    
    def create_warehouses_api(self):
        """Create warehouses via API"""
        logger.info("Creating warehouses via API...")
        
        Warehouse = self.odoo.env['stock.warehouse']
        
        warehouses_data = [
            {"name": "Main Warehouse", "code": "MAIN"},
            {"name": "Branch 1", "code": "BR1"},
            {"name": "Branch 2", "code": "BR2"}
        ]
        
        for wh_data in warehouses_data:
            try:
                # Check if exists
                existing = Warehouse.search([('code', '=', wh_data['code'])])
                
                if existing:
                    wh_id = existing[0]
                    logger.info(f"âœ… {wh_data['name']} already exists (ID: {wh_id})")
                else:
                    # Create warehouse
                    wh_id = Warehouse.create({
                        'name': wh_data['name'],
                        'code': wh_data['code']
                    })
                    logger.info(f"âœ… Created {wh_data['name']} (ID: {wh_id})")
                
                self.warehouses[wh_data['code']] = wh_id
                
            except Exception as e:
                logger.error(f"Error creating {wh_data['name']}: {e}")
    
    def configure_warehouse_routes_api(self):
        """Configure warehouse routes via API"""
        logger.info("Configuring warehouse routes...")
        
        try:
            Warehouse = self.odoo.env['stock.warehouse']
            
            # Configure Branch 1 and Branch 2 to resupply from Main
            for branch_code in ['BR1', 'BR2']:
                if branch_code in self.warehouses:
                    branch_id = self.warehouses[branch_code]
                    
                    # Enable resupply from another warehouse
                    Warehouse.write([branch_id], {
                        'resupply_wh_ids': [(4, self.warehouses['MAIN'])]  # Link to Main Warehouse
                    })
                    
                    logger.info(f"âœ… Configured {branch_code} to resupply from Main Warehouse")
                    
        except Exception as e:
            logger.warning(f"Route configuration (may need manual setup): {e}")
    
    def create_product_attributes_api(self):
        """Create product attributes (Color, Size)"""
        logger.info("Creating product attributes...")
        
        Attribute = self.odoo.env['product.attribute']
        AttributeValue = self.odoo.env['product.attribute.value']
        
        attributes = {}
        
        # Create Color attribute
        try:
            color_ids = Attribute.search([('name', '=', 'Color')])
            if color_ids:
                color_id = color_ids[0]
            else:
                color_id = Attribute.create({'name': 'Color'})
            
            # Create color values
            colors = ['White', 'Black', 'Blue', 'Dark Blue', 'Light Blue', 'Red', 'Yellow']
            for color in colors:
                value_ids = AttributeValue.search([
                    ('attribute_id', '=', color_id),
                    ('name', '=', color)
                ])
                if not value_ids:
                    AttributeValue.create({
                        'attribute_id': color_id,
                        'name': color
                    })
            
            attributes['Color'] = color_id
            logger.info("âœ… Color attribute configured")
            
        except Exception as e:
            logger.warning(f"Color attribute: {e}")
        
        # Create Size attribute
        try:
            size_ids = Attribute.search([('name', '=', 'Size')])
            if size_ids:
                size_id = size_ids[0]
            else:
                size_id = Attribute.create({'name': 'Size'})
            
            # Create size values
            sizes = ['S', 'M', 'L', 'XL', '42', '44', '46', '48']
            for size in sizes:
                value_ids = AttributeValue.search([
                    ('attribute_id', '=', size_id),
                    ('name', '=', size)
                ])
                if not value_ids:
                    AttributeValue.create({
                        'attribute_id': size_id,
                        'name': size
                    })
            
            attributes['Size'] = size_id
            logger.info("âœ… Size attribute configured")
            
        except Exception as e:
            logger.warning(f"Size attribute: {e}")
        
        return attributes
    
    def create_products_api(self):
        """Create all products with variants via API"""
        logger.info("Creating products with variants via API...")
        
        Product = self.odoo.env['product.template']
        Attribute = self.odoo.env['product.attribute']
        AttributeValue = self.odoo.env['product.attribute.value']
        
        # First, let's check what product type field exists
        try:
            # Get field info for product.template
            fields_info = Product.fields_get(['type', 'detailed_type'])
            logger.info(f"Available product fields: {list(fields_info.keys())}")
            
            # Check which field has selection options
            for field_name, field_info in fields_info.items():
                if field_info.get('type') == 'selection':
                    logger.info(f"Field '{field_name}' options: {field_info.get('selection')}")
                    
        except Exception as e:
            logger.warning(f"Could not get field info: {e}")
        
        # Get attribute IDs
        color_attr = Attribute.search([('name', '=', 'Color')])
        size_attr = Attribute.search([('name', '=', 'Size')])
        
        if not color_attr or not size_attr:
            logger.warning("Attributes not found, creating them first...")
            self.create_product_attributes_api()
            color_attr = Attribute.search([('name', '=', 'Color')])
            size_attr = Attribute.search([('name', '=', 'Size')])
        
        color_attr_id = color_attr[0] if color_attr else None
        size_attr_id = size_attr[0] if size_attr else None
        
        products_data = [
            {
                "name": "Plain Tshirt",
                "list_price": 25.0,
                "standard_price": 15.0,
                "variants": [
                    {"attr_id": color_attr_id, "values": ["White", "Black", "Blue"]},
                    {"attr_id": size_attr_id, "values": ["S", "M", "L", "XL"]}
                ]
            },
            {
                "name": "Jeans",
                "list_price": 65.0,
                "standard_price": 40.0,
                "variants": [
                    {"attr_id": color_attr_id, "values": ["Dark Blue", "Light Blue"]},
                    {"attr_id": size_attr_id, "values": ["42", "44", "46", "48"]}
                ]
            },
            {
                "name": "Full Suit",
                "list_price": 250.0,
                "standard_price": 150.0,
                "variants": []
            },
            {
                "name": "Sneakers",
                "list_price": 85.0,
                "standard_price": 50.0,
                "variants": [
                    {"attr_id": color_attr_id, "values": ["Red", "Yellow", "White"]},
                    {"attr_id": size_attr_id, "values": ["42", "44", "46", "48"]}
                ]
            }
        ]
        
        for prod_data in products_data:
            try:
                # Check if product exists
                existing = Product.search([('name', '=', prod_data['name'])])
                
                if existing:
                    product_id = existing[0]
                    logger.info(f"âœ… {prod_data['name']} already exists (ID: {product_id})")
                    self.products[prod_data['name']] = product_id
                    continue
                
                # Step 1: Create basic product template
                # Use 'consu' (Goods) - this Odoo version doesn't support storable products
                product_vals = {
                    'name': prod_data['name'],
                    'list_price': prod_data['list_price'],
                    'standard_price': prod_data['standard_price'],
                    'sale_ok': True,
                    'purchase_ok': True,
                    'type': 'consu',  # Goods/Consumable
                }
                
                logger.info(f"Creating {prod_data['name']} as type 'consu' (Goods)")
                
                # Step 2: Add attribute lines if variants exist
                # This tells Odoo which attributes this product has
                if prod_data['variants']:
                    attribute_line_ids = []
                    
                    for variant in prod_data['variants']:
                        if not variant['attr_id']:
                            continue
                            
                        # Get value IDs for this attribute
                        value_ids = []
                        for value_name in variant['values']:
                            val = AttributeValue.search([
                                ('attribute_id', '=', variant['attr_id']),
                                ('name', '=', value_name)
                            ])
                            if val:
                                value_ids.append(val[0])
                        
                        # Create attribute line
                        # Format: (0, 0, {dictionary of values})
                        # This is Odoo's special "create new record" command
                        if value_ids:
                            attribute_line_ids.append((0, 0, {
                                'attribute_id': variant['attr_id'],
                                'value_ids': [(6, 0, value_ids)]  # (6, 0, [ids]) = set these IDs
                            }))
                    
                    if attribute_line_ids:
                        product_vals['attribute_line_ids'] = attribute_line_ids
                
                # Step 3: Create the product
                # Odoo will automatically create all variant combinations
                product_id = Product.create(product_vals)
                
                # Step 4: Wait for variant generation
                import time
                time.sleep(1)  # Give Odoo time to generate variants
                
                logger.info(f"âœ… Created {prod_data['name']} (ID: {product_id})")
                
                # Verify variants were created
                product_obj = Product.browse(product_id)
                variant_count = len(product_obj.product_variant_ids)
                logger.info(f"   â†’ Generated {variant_count} variants")
                
                self.products[prod_data['name']] = product_id
                
            except Exception as e:
                logger.error(f"âŒ Error creating {prod_data['name']}: {e}")
                logger.info(f"   You may need to create this product manually in Odoo")
                import traceback
                logger.debug(traceback.format_exc())
    
    def update_stock_quantities_api(self):
        """Update stock quantities via API"""
        logger.info("Updating stock quantities...")
        
        try:
            Product = self.odoo.env['product.product']
            Quant = self.odoo.env['stock.quant']
            Location = self.odoo.env['stock.location']
            
            # Get Main Warehouse stock location
            main_location = Location.search([
                ('usage', '=', 'internal'),
                ('complete_name', 'ilike', 'MAIN/Stock')
            ], limit=1)
            
            if not main_location:
                # Fallback to any internal location
                main_location = Location.search([
                    ('usage', '=', 'internal')
                ], limit=1)
            
            if not main_location:
                logger.warning("Could not find stock location")
                return
            
            location_id = main_location[0]
            logger.info(f"Using location ID: {location_id}")
            
            # Get all our product variants
            all_products = Product.search([
                ('product_tmpl_id', 'in', list(self.products.values()))
            ])
            
            logger.info(f"Updating stock for {len(all_products)} product variants...")
            
            # Update quantity for each variant
            for product_id in all_products:
                try:
                    product = Product.browse(product_id)
                    
                    # Check if quant already exists
                    existing_quant = Quant.search([
                        ('product_id', '=', product_id),
                        ('location_id', '=', location_id)
                    ], limit=1)
                    
                    if existing_quant:
                        # Update existing
                        Quant.write([existing_quant[0]], {
                            'inventory_quantity': 100.0,
                        })
                        # Apply inventory adjustment
                        quant = Quant.browse(existing_quant[0])
                        quant.action_apply_inventory()
                    else:
                        # Create new quant
                        Quant.create({
                            'product_id': product_id,
                            'location_id': location_id,
                            'inventory_quantity': 100.0,
                        })
                    
                    logger.info(f"âœ… Set stock for {product.display_name}: 100 units")
                    
                except Exception as e:
                    logger.warning(f"Could not update stock for product {product_id}: {e}")
            
            logger.info("âœ… Stock quantities updated")
                    
        except Exception as e:
            logger.warning(f"Stock update error: {e}")
            logger.info("You may need to update stock quantities manually")
    
    def create_vip_pricelist_api(self):
        """Create VIP pricelist with quantity-based discounts"""
        logger.info("Creating VIP pricelist...")
        
        try:
            Pricelist = self.odoo.env['product.pricelist']
            PricelistItem = self.odoo.env['product.pricelist.item']
            
            # Check if VIP pricelist exists
            existing = Pricelist.search([('name', '=', 'VIP Customer Pricelist')])
            
            if existing:
                pricelist_id = existing[0]
                logger.info(f"âœ… VIP pricelist already exists (ID: {pricelist_id})")
            else:
                # Create pricelist
                pricelist_id = Pricelist.create({
                    'name': 'VIP Customer Pricelist'
                })
                logger.info(f"âœ… Created VIP pricelist (ID: {pricelist_id})")
            
            # Create discount rules
            # Rule 1: 20% discount for quantity 1-10
            rule1 = PricelistItem.search([
                ('pricelist_id', '=', pricelist_id),
                ('min_quantity', '=', 1)
            ])
            
            if not rule1:
                PricelistItem.create({
                    'pricelist_id': pricelist_id,
                    'applied_on': '3_global',  # All products
                    'min_quantity': 1,
                    'compute_price': 'percentage',
                    'percent_price': 20,  # 20% discount
                })
                logger.info("âœ… Created 20% discount rule (qty 1-10)")
            
            # Rule 2: 25% discount for quantity > 10
            rule2 = PricelistItem.search([
                ('pricelist_id', '=', pricelist_id),
                ('min_quantity', '=', 11)
            ])
            
            if not rule2:
                PricelistItem.create({
                    'pricelist_id': pricelist_id,
                    'applied_on': '3_global',  # All products
                    'min_quantity': 11,
                    'compute_price': 'percentage',
                    'percent_price': 25,  # 25% discount
                })
                logger.info("âœ… Created 25% discount rule (qty > 10)")
                
        except Exception as e:
            logger.error(f"Pricelist creation error: {e}")
    
    def configure_purchase_approval_api(self):
        """Configure purchase approval settings"""
        logger.info("Configuring purchase approval...")
        
        try:
            Company = self.odoo.env['res.company']
            company_id = self.odoo.env.user.company_id.id
            
            Company.write([company_id], {
                'po_double_validation': 'two_step',
                'po_double_validation_amount': 0.0
            })
            
            logger.info("âœ… Purchase approval configured (threshold: â‚¬0)")
            
        except Exception as e:
            logger.warning(f"Purchase approval config: {e}")
    
    def create_reordering_rules_api(self):
        """Create reordering rules for products"""
        logger.info("Creating reordering rules...")
        
        try:
            OrderPoint = self.odoo.env['stock.warehouse.orderpoint']
            Product = self.odoo.env['product.product']
            Location = self.odoo.env['stock.location']
            
            # Get products
            products = Product.search([('type', '=', 'product')], limit=10)
            
            # Get locations for branches
            branch1_location = Location.search([
                ('name', 'ilike', 'Stock'),
                ('location_id.name', 'ilike', 'BR1')
            ], limit=1)
            
            for product_id in products:
                try:
                    # Check if rule exists
                    existing = OrderPoint.search([
                        ('product_id', '=', product_id)
                    ])
                    
                    if not existing:
                        OrderPoint.create({
                            'product_id': product_id,
                            'location_id': branch1_location[0] if branch1_location else False,
                            'product_min_qty': 10.0,
                            'product_max_qty': 50.0,
                        })
                        
                        product = Product.browse(product_id)
                        logger.info(f"âœ… Created reordering rule for {product.name}")
                        
                except Exception as e:
                    continue
                    
        except Exception as e:
            logger.warning(f"Reordering rules: {e}")

    # ============ COMPLETE BUSINESS FLOW ============
    
    def create_complete_opportunity_api(self):
        """Create complete CRM opportunity via API"""
        logger.info("Creating complete CRM opportunity via API...")
        
        try:
            Lead = self.odoo.env['crm.lead']
            Partner = self.odoo.env['res.partner']
            
            # Create or get customer
            existing_partner = Partner.search([('email', '=', self.customer_email)], limit=1)
            
            if existing_partner:
                partner_id = existing_partner[0]
                logger.info(f"âœ… Customer already exists (ID: {partner_id})")
            else:
                partner_id = Partner.create({
                    'name': self.customer_name,
                    'email': self.customer_email,
                    'customer_rank': 1,
                })
                logger.info(f"âœ… Created customer (ID: {partner_id})")
            
            # Create opportunity
            opportunity_id = Lead.create({
                'name': 'Wholesale Clothing Order - Maciej',
                'partner_id': partner_id,
                'email_from': self.customer_email,
                'type': 'opportunity',
                'expected_revenue': 1000.0,
            })
            
            logger.info(f"âœ… Created CRM opportunity (ID: {opportunity_id})")
            return opportunity_id
            
        except Exception as e:
            logger.error(f"Opportunity creation error: {e}")
            return None
    
    def create_sales_order_api(self, opportunity_id):
        """Create sales order from opportunity via API"""
        logger.info("Creating sales order from opportunity...")
        
        try:
            SaleOrder = self.odoo.env['sale.order']
            SaleOrderLine = self.odoo.env['sale.order.line']
            Partner = self.odoo.env['res.partner']
            Product = self.odoo.env['product.product']
            Warehouse = self.odoo.env['stock.warehouse']
            
            # Get customer
            partner = Partner.search([('email', '=', self.customer_email)], limit=1)
            if not partner:
                logger.error("Customer not found")
                return None
            
            partner_id = partner[0]
            
            # Get Branch 1 warehouse
            branch1 = Warehouse.search([('code', '=', 'BR1')], limit=1)
            warehouse_id = branch1[0] if branch1 else False
            
            # Create sales order
            order_vals = {
                'partner_id': partner_id,
                'opportunity_id': opportunity_id,
                'warehouse_id': warehouse_id,
            }
            
            order_id = SaleOrder.create(order_vals)
            logger.info(f"âœ… Created sales order (ID: {order_id})")
            
            # Add order lines
            products_to_add = [
                {'template': 'Plain Tshirt', 'color': 'White', 'size': 'M', 'qty': 15},
                {'template': 'Jeans', 'color': 'Dark Blue', 'size': '44', 'qty': 8},
                {'template': 'Sneakers', 'color': 'Red', 'size': '42', 'qty': 5},
            ]
            
            for item in products_to_add:
                try:
                    # Get product template
                    template = Product.env['product.template'].search([
                        ('name', '=', item['template'])
                    ], limit=1)
                    
                    if not template:
                        logger.warning(f"Template not found: {item['template']}")
                        continue
                    
                    # Find variant with matching attributes
                    variants = Product.search([
                        ('product_tmpl_id', '=', template[0])
                    ])
                    
                    for variant_id in variants:
                        variant = Product.browse(variant_id)
                        variant_name = variant.display_name
                        
                        # Check if this variant matches our criteria
                        if item['color'] in variant_name and item['size'] in variant_name:
                            SaleOrderLine.create({
                                'order_id': order_id,
                                'product_id': variant_id,
                                'product_uom_qty': item['qty'],
                            })
                            logger.info(f"âœ… Added: {variant_name} x {item['qty']}")
                            break
                    else:
                        logger.warning(f"Variant not found for: {item['template']} {item['color']} / {item['size']}")
                        
                except Exception as e:
                    logger.warning(f"Could not add product line: {e}")
            
            return order_id
            
        except Exception as e:
            logger.error(f"Sales order creation error: {e}")
            return None
    
    def confirm_sales_order_api(self, order_id):
        """Confirm sales order via API"""
        logger.info("Confirming sales order...")
        
        try:
            SaleOrder = self.odoo.env['sale.order']
            order = SaleOrder.browse(order_id)
            order.action_confirm()
            logger.info("âœ… Sales order confirmed")
            return True
        except Exception as e:
            logger.error(f"Order confirmation error: {e}")
            return False
    
    def process_delivery_api(self, order_id):
        """Process delivery via API"""
        logger.info("Processing delivery...")
        
        try:
            SaleOrder = self.odoo.env['sale.order']
            StockPicking = self.odoo.env['stock.picking']
            
            order = SaleOrder.browse(order_id)
            
            # Get delivery picking
            pickings = order.picking_ids
            
            if not pickings:
                logger.warning("No delivery found")
                return False
            
            for picking_id in pickings:
                picking = StockPicking.browse(picking_id)
                
                if picking.state not in ['done', 'cancel']:
                    # Set quantities done
                    for move in picking.move_ids_without_package:
                        move.quantity_done = move.product_uom_qty
                    
                    # Validate picking
                    picking.button_validate()
                    logger.info(f"âœ… Validated delivery {picking.name}")
            
            return True
            
        except Exception as e:
            logger.error(f"Delivery processing error: {e}")
            return False
    
    def create_invoice_api(self, order_id):
        """Create and post invoice via API"""
        logger.info("Creating invoice...")
        
        try:
            SaleOrder = self.odoo.env['sale.order']
            order = SaleOrder.browse(order_id)
            
            # Create invoice
            invoice = order._create_invoices()
            
            if invoice:
                # Post invoice
                invoice.action_post()
                logger.info(f"âœ… Invoice created and posted (ID: {invoice.id})")
                return invoice.id
            else:
                logger.warning("Could not create invoice")
                return None
                
        except Exception as e:
            logger.error(f"Invoice creation error: {e}")
            return None
    
    def mark_opportunity_won_api(self, opportunity_id):
        """Mark opportunity as won via API"""
        logger.info("Marking opportunity as won...")
        
        try:
            Lead = self.odoo.env['crm.lead']
            opportunity = Lead.browse(opportunity_id)
            opportunity.action_set_won()
            logger.info("âœ… Opportunity marked as won")
            return True
        except Exception as e:
            logger.error(f"Mark as won error: {e}")
            return False
    
    def create_crm_opportunity_browser(self):
        """Create CRM opportunity via browser"""
        logger.info("Creating CRM opportunity...")
        
        self.driver.get(f"{self.url}/web#action=crm.crm_lead_all_leads")
        time.sleep(4)
        
        try:
            # Create new
            create_btn = self.wait.until(
                EC.element_to_be_clickable((By.XPATH, "//button[contains(@class, 'o_list_button_add')]"))
            )
            create_btn.click()
            time.sleep(3)
            
            # Fill fields with better wait and error handling
            try:
                name_field = self.wait.until(
                    EC.presence_of_element_located((By.NAME, "name"))
                )
                # Scroll into view
                self.driver.execute_script("arguments[0].scrollIntoView(true);", name_field)
                time.sleep(0.5)
                # Click first to focus
                name_field.click()
                time.sleep(0.5)
                name_field.clear()
                name_field.send_keys("Wholesale Clothing Order - Maciej")
                logger.info("âœ… Filled opportunity name")
            except Exception as e:
                logger.warning(f"Could not fill name field: {e}")
            
            try:
                email_field = self.driver.find_element(By.XPATH, "//input[contains(@name, 'email') or contains(@id, 'email')]")
                self.driver.execute_script("arguments[0].scrollIntoView(true);", email_field)
                email_field.click()
                time.sleep(0.3)
                email_field.send_keys(self.customer_email)
                logger.info("âœ… Filled email")
            except Exception as e:
                logger.warning(f"Could not fill email: {e}")
            
            try:
                partner_field = self.driver.find_element(By.XPATH, "//input[contains(@placeholder, 'Company') or contains(@name, 'partner')]")
                self.driver.execute_script("arguments[0].scrollIntoView(true);", partner_field)
                partner_field.click()
                time.sleep(0.3)
                partner_field.send_keys(self.customer_name)
                logger.info("âœ… Filled customer name")
            except Exception as e:
                logger.warning(f"Could not fill customer: {e}")
            
            # Save
            try:
                save_btn = self.driver.find_element(By.XPATH, "//button[contains(@class, 'o_form_button_save')]")
                save_btn.click()
                time.sleep(2)
                logger.info("âœ… CRM opportunity saved")
            except:
                logger.info("Auto-save enabled, no manual save needed")
            
            logger.info("âœ… CRM opportunity created")
            
        except Exception as e:
            logger.error(f"CRM opportunity creation error: {e}")
            logger.info("\nPlease create the CRM opportunity manually:")
            logger.info(f"  Name: Wholesale Clothing Order - Maciej")
            logger.info(f"  Email: {self.customer_email}")
            logger.info(f"  Customer: {self.customer_name}")
            input("\nPress Enter after creating it manually...")
    
    def run_complete_automation(self):
        """Run complete automation - Configuration + Full Business Flow"""
        try:
            # Step 1: Connect to API
            if not self.connect_api():
                return
            
            logger.info("\n" + "="*60)
            logger.info("PART 1: CONFIGURATION VIA API")
            logger.info("="*60)
            
            self.create_warehouses_api()
            self.configure_warehouse_routes_api()
            self.create_product_attributes_api()
            self.create_products_api()
            self.update_stock_quantities_api()
            self.create_vip_pricelist_api()
            self.configure_purchase_approval_api()
            self.create_reordering_rules_api()
            
            logger.info("\nâœ… Configuration complete via API!")
            
            # Step 2: Complete Business Flow via API
            logger.info("\n" + "="*60)
            logger.info("PART 2: COMPLETE BUSINESS FLOW VIA API")
            logger.info("="*60)
            
            logger.info("\n[STEP 1] Creating CRM Opportunity")
            opportunity_id = self.create_complete_opportunity_api()
            
            if not opportunity_id:
                logger.error("Failed to create opportunity")
                return
            
            logger.info("\n[STEP 2] Creating Sales Order from Opportunity")
            order_id = self.create_sales_order_api(opportunity_id)
            
            if not order_id:
                logger.error("Failed to create sales order")
                return
            
            logger.info("\n[STEP 3] Confirming Sales Order")
            if not self.confirm_sales_order_api(order_id):
                logger.error("Failed to confirm sales order")
                return
            
            logger.info("\n[STEP 4] Processing Delivery")
            if not self.process_delivery_api(order_id):
                logger.warning("Delivery processing had issues")
            
            logger.info("\n[STEP 5] Creating and Posting Invoice")
            invoice_id = self.create_invoice_api(order_id)
            
            if not invoice_id:
                logger.warning("Invoice creation had issues")
            
            logger.info("\n[STEP 6] Marking Opportunity as Won")
            self.mark_opportunity_won_api(opportunity_id)
            
            logger.info("\n" + "="*60)
            logger.info("âœ… COMPLETE AUTOMATION FINISHED!")
            logger.info("="*60)
            logger.info("\nSummary:")
            logger.info(f"  â€¢ Configuration: Complete")
            logger.info(f"  â€¢ Products: 33 variants created")
            logger.info(f"  â€¢ Stock: Updated")
            logger.info(f"  â€¢ CRM Opportunity: Created (ID: {opportunity_id})")
            logger.info(f"  â€¢ Sales Order: Created & Confirmed (ID: {order_id})")
            logger.info(f"  â€¢ Delivery: Processed")
            if invoice_id:
                logger.info(f"  â€¢ Invoice: Posted (ID: {invoice_id})")
            logger.info(f"  â€¢ Opportunity: Marked as Won")
            logger.info("\nðŸŽ‰ Full Azita Clothing workflow completed!")
            logger.info("\nYou can now:")
            logger.info(f"  1. View the sales order in Odoo")
            logger.info(f"  2. Check the delivery documents")
            logger.info(f"  3. Review the posted invoice")
            logger.info(f"  4. See the won opportunity in CRM")
            
            input("\nPress Enter to close...")
            
        except Exception as e:
            logger.error(f"Automation failed: {e}")
            import traceback
            traceback.print_exc()
            input("Press Enter to close...")
        
        finally:
            if self.driver:
                self.driver.quit()


if __name__ == "__main__":
    print("="*60)
    print("ODOO API-BASED COMPLETE AUTOMATION")
    print("="*60)
    print("\nThis agent uses Odoo's API for reliable configuration")
    print("and browser automation only when necessary.\n")
    
    # Get credentials
    url = input("Odoo URL [https://edu-loopingcomp.odoo.com]: ").strip() or "https://edu-loopingcomp.odoo.com"
    db = input("Database name [edu-loopingcomp]: ").strip() or "edu-loopingcomp"
    username = input("Username (email): ").strip()
    api_key = input("API Key: ").strip()
    
    print("\n" + "="*60)
    print("Starting automation...")
    print("="*60 + "\n")
    
    agent = OdooAPIAgent(url, db, username, api_key)
    agent.run_complete_automation()
